<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observation Planner - Kinder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/observation_planner.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/observation_planner_extra.css') }}">
    {% include '_favicon.html' %}
</head>
<body>
    {% include '_navbar.html' %}

    <div class="container main-content">
        <div class="header-section">
            <h1>Observation Planner</h1>
            <p class="subtitle">Generate ACP observation scripts for LOT/SLT telescopes</p>
        </div>

        <div class="planner-container">
            <!-- Global Settings -->
            <div class="settings-panel">
                <h3>Global Settings</h3>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="telescope-select">Telescope</label>
                        <select id="telescope-select" class="form-control">
                            <option value="LOT">LOT (Lulin One-meter Telescope)</option>
                            <option value="SLT">SLT (Super Light Telescope)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="observation-date">Observation Date</label>
                        <input type="text" id="observation-date" class="form-control" placeholder="YYYY/MM/DD">
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="send-control" checked>
                        <label for="send-control">Send to Control Room (Script Header)</label>
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-primary" onclick="fetchFollowUpTargets()">
                        <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg> Fetch Follow-up Targets
                    </button>
                    <button type="button" class="btn btn-primary" onclick="fetchCustomTargets()">
                        <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> Fetch Custom Targets
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="addTargetRow()">
                        <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add Manual Target
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearAllTargets()">
                        <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> Clear All
                    </button>
                </div>
            </div>

            <!-- Target List -->
            <div class="targets-panel">
                <h3>Target List</h3>
                <div class="table-responsive">
                    <table class="targets-table" id="targets-table">
                        <thead>
                            <tr>
                                <th style="width: 10%">Object Name</th>
                                <th style="width: 8%">RA</th>
                                <th style="width: 8%">Dec</th>
                                <th style="width: 5%">Mag</th>
                                <th style="width: 8%">Priority</th>
                                <th style="width: 25%">Exposure Settings</th>
                                <th style="width: 5%">Repeat</th>
                                <th style="width: 25%">Info</th>
                                <th style="width: 6%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="targets-body">
                            <!-- Rows will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-state" class="empty-state">
                    <p>No targets added. Fetch follow-up targets or add one manually.</p>
                </div>
            </div>

            <!-- Generation Section -->
            <div class="generation-panel">
                <button type="button" class="btn btn-success btn-large" onclick="generateScript()">
                    <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg> Generate Script
                </button>
            </div>

            <!-- Output Section -->
            <div class="output-panel">
                <h3>Generated Output</h3>
                <div class="output-wrapper">
                    <textarea id="script-output" readonly placeholder="Generated script will appear here..."></textarea>
                    <button class="btn-copy" onclick="copyToClipboard()">Copy</button>
                </div>
                <div id="plot-container" class="plot-container" style="display: none; margin-top: 30px;">
                    <h4 style="color: #C5A059; margin-bottom: 15px; font-weight: 400;">Object Visibility</h4>
                    <img id="visibility-plot" src="" alt="Visibility Plot" style="width: 100%; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                </div>
            </div>
        </div>
    </div>

    <!-- Template for a row (hidden) -->
    <template id="row-template">
        <tr class="target-row">
            <td><input type="text" class="form-control field-name" placeholder="Name"></td>
            <td><input type="text" class="form-control field-ra" placeholder="HH:MM:SS"></td>
            <td><input type="text" class="form-control field-dec" placeholder="DD:MM:SS"></td>
            <td><input type="text" class="form-control field-mag" placeholder="Mag"></td>
            <td>
                <select class="form-control field-priority">
                    <option value="Urgent">Urgent</option>
                    <option value="High">High</option>
                    <option value="Normal" selected>Normal</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </td>
            <td class="exposure-settings-cell">
                <div class="auto-toggle-wrapper">
                    <label class="checkbox-label">
                        <input type="checkbox" class="field-auto" checked onchange="toggleAutoExposure(this)">
                        Auto by Mag
                    </label>
                </div>
                
                <div class="manual-exposures" style="display: none;">
                    <div class="exposure-list">
                        <!-- Exposure rows go here -->
                    </div>
                    <button type="button" class="btn-small btn-secondary add-exposure-btn" onclick="addExposureRow(this)">+ Add Filter</button>
                </div>
                <div class="auto-info" style="display: block;">
                    <small class="text-muted">Exposures calculated automatically</small>
                </div>
            </td>
            <td><input type="number" class="form-control field-repeat" value="0" min="0"></td>
            <td><input type="text" class="form-control field-info" placeholder="Optional info"></td>
            <td class="text-center">
                <button type="button" class="btn-icon delete-row" onclick="removeRow(this)" title="Remove">
                    <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </td>
        </tr>
    </template>

    <template id="exposure-row-template">
        <div class="exposure-row">
            <select class="form-control field-filter" style="width: 80px;">
                <option value="">None</option>
                <option value="up">u</option>
                <option value="gp">g</option>
                <option value="rp" selected>r</option>
                <option value="ip">i</option>
                <option value="zp">z</option>
            </select>
            <input type="text" class="form-control field-exp" value="300" placeholder="Sec" style="width: 60px;">
            <input type="number" class="form-control field-count" value="3" min="1" placeholder="#" style="width: 50px;">
            <button type="button" class="btn-icon remove-exposure" onclick="removeExposureRow(this)">
                <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </template>

    <script src="{{ url_for('static', filename='js/observation_planner.js') }}"></script>
</body>
</html>